From 8b3357bc80d4cab9c5d75fc919e58fbd55274420 Mon Sep 17 00:00:00 2001
From: Scott Ware <scott.r.ware@intel.com>
Date: Wed, 8 Apr 2020 14:50:18 +0100
Subject: [PATCH] Compile parson into main libs

Signed-off-by: Scott Ware <scott.r.ware@intel.com>
---
 CMakeLists.txt               | 18 +-----------------
 iothub_client/CMakeLists.txt | 10 ++--------
 serializer/CMakeLists.txt    | 10 ++--------
 3 files changed, 5 insertions(+), 33 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index e92da5c..7d49b2c 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -177,16 +177,8 @@ endif()
 # Use solution folders.
 set_property(GLOBAL PROPERTY USE_FOLDERS ON)
 
-# build the parson library for json parsing
-add_library(parson
-    ./deps/parson/parson.c
-    ./deps/parson/parson.h
-)
-if (MSVC)
-    set_source_files_properties(../deps/parson/parson.c PROPERTIES COMPILE_FLAGS "/wd4244 /wd4232")
-endif()
+# Parson
 set(parson_h_install_files ./deps/parson/parson.h)
-set(parson_install_libs parson)
 
 if (IN_OPENWRT)
     ADD_DEFINITIONS("$ENV{TARGET_LDFLAGS}" "$ENV{TARGET_CPPFLAGS}" "$ENV{TARGET_CFLAGS}")
@@ -422,11 +414,6 @@ if (${use_installed_dependencies})
     install(FILES ${parson_h_install_files}
         DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/azureiot
     )
-    install(TARGETS ${parson_install_libs} EXPORT azure_iot_sdksTargets
-        ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
-        LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
-        INCLUDES DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/azureiot
-    )
 
     install(EXPORT azure_iot_sdksTargets
         FILE
@@ -446,8 +433,5 @@ if (${use_installed_dependencies})
 else()
     install(FILES ${parson_h_install_files}
         DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/azureiot)
-    install(TARGETS ${parson_install_libs}
-        ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
-        LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR})
 endif()
 
diff --git a/iothub_client/CMakeLists.txt b/iothub_client/CMakeLists.txt
index d04f7bd..c14d36f 100644
--- a/iothub_client/CMakeLists.txt
+++ b/iothub_client/CMakeLists.txt
@@ -24,6 +24,7 @@ set(iothub_client_c_files
     ./src/iothub_module_client_ll.c
     ./src/iothubtransport.c
     ./src/version.c
+    ../deps/parson/parson.c
 )
 
 set(iothub_client_h_files
@@ -45,6 +46,7 @@ set(iothub_client_h_files
     ./inc/iothub_transport_ll.h
     ./inc/iothub_message.h
     ./inc/internal/iothubtransport.h
+    ../deps/parson/parson.h
 )
 
 set(iothub_client_libs)
@@ -431,13 +433,6 @@ if (${build_as_dynamic})
     if (${use_prov_client_core})
         target_link_libraries(iothub_client_dll hsm_security_client prov_auth_client)
     endif()
-    target_link_libraries(iothub_client_dll parson)
-
-    if (${CMAKE_C_COMPILER_ID} STREQUAL "GNU" OR ${CMAKE_C_COMPILER_ID} STREQUAL "Clang")
-        target_link_libraries(iothub_client_dll
-            "-Wl,--exclude-libs,libparson.a"
-        )
-    endif()
 
     set(install_staticlibs ${install_staticlibs} iothub_client_dll)
 endif()
@@ -448,7 +443,6 @@ add_library(iothub_client
 )
 setSdkTargetBuildProperties(iothub_client)
 target_link_libraries(iothub_client ${iothub_client_libs})
-target_link_libraries(iothub_client parson)
 
 if (${use_prov_client_core})
     target_link_libraries(iothub_client hsm_security_client prov_auth_client)
diff --git a/serializer/CMakeLists.txt b/serializer/CMakeLists.txt
index 419f4d7..7173ce2 100644
--- a/serializer/CMakeLists.txt
+++ b/serializer/CMakeLists.txt
@@ -33,6 +33,7 @@ set(serializer_c_files
     ./src/schemalib.c
     ./src/schemaserializer.c
     ./src/methodreturn.c
+    ../deps/parson/parson.c
 )
 
 set(serializer_h_files
@@ -52,6 +53,7 @@ set(serializer_h_files
     ./inc/serializer.h
     ./inc/serializer_devicetwin.h
     ./inc/methodreturn.h
+    ../deps/parson/parson.h
 )
 
 #these are the include folders
@@ -68,7 +70,6 @@ IF(WIN32)
 ENDIF(WIN32)
 
 add_library(serializer ${serializer_c_files} ${serializer_h_files})
-target_link_libraries(serializer parson)
 
 set (install_libs serializer)
 
@@ -78,15 +79,8 @@ if (${build_as_dynamic})
     )
     target_link_libraries(serializer_dll
         aziotsharedutil_dll
-        parson
     )
 
-    if (${CMAKE_C_COMPILER_ID} STREQUAL "GNU" OR ${CMAKE_C_COMPILER_ID} STREQUAL "Clang")
-        target_link_libraries(serializer_dll
-            "-Wl,--exclude-libs,libparson.a"
-        )
-    endif()
-
     set_target_properties(serializer_dll PROPERTIES
         OUTPUT_NAME "serializer"
         ARCHIVE_OUTPUT_NAME "serializer_dll_import"
-- 
2.7.4

